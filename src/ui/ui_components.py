# src/ui/ui_components.py

import streamlit as st
import pandas as pd
from src.config.config_settings import SQL_SCHEMA
from src.services.services_gpt import GPTService
from src.services.services_pdf import PDFService
from src.services.services_data import DataService
from src.ui.styles import QUERY_STYLES, UPLOAD_STYLES, VIEWER_STYLES


def render_upload():
    st.markdown(UPLOAD_STYLES, unsafe_allow_html=True)
    st.header("Upload de Curr√≠culos")

    with st.container():
        arquivos = st.file_uploader(
            "Selecione os PDFs dos curr√≠culos",
            type="pdf",
            accept_multiple_files=True,
            help="Voc√™ pode selecionar m√∫ltiplos arquivos PDF ou um √∫nico PDF com v√°rios curr√≠culos"
        )

        if arquivos:
            gpt_service = GPTService()
            pdf_service = PDFService()
            data_service = DataService()

            progress_bar = st.progress(0)
            status_text = st.empty()

            total_processado = 0
            total_curriculos = 0


            for arquivo in arquivos:
                try:
                    curriculos = pdf_service.extrair_curriculos_multiplos(arquivo)
                    total_curriculos += len(curriculos)
                except Exception as e:
                    st.error(f"Erro ao analisar {arquivo.name}: {e}")
                    continue


            for arquivo in arquivos:
                try:

                    curriculos = pdf_service.extrair_curriculos_multiplos(arquivo)


                    st.info(f"Encontrados {len(curriculos)} curr√≠culos em {arquivo.name}")


                    if curriculos:
                        st.write("Candidatos identificados neste arquivo:")
                        dados_candidatos = []
                        for info, _ in curriculos:
                            dados_candidatos.append({
                                "Nome": info.get('nome', 'N√£o identificado'),
                                "Email": info.get('email', 'N√£o informado'),
                                "Telefone": info.get('telefone', 'N√£o informado')
                            })
                        st.table(dados_candidatos)


                    for idx, (info, texto_cv) in enumerate(curriculos, 1):
                        total_processado += 1
                        progress = total_processado / total_curriculos
                        progress_bar.progress(progress)

                        nome_candidato = info.get('nome', f'Candidato {idx}')
                        status_text.text(
                            f"Processando curr√≠culo de {nome_candidato} ({idx}/{len(curriculos)}) do arquivo {arquivo.name}")

                        try:
                            with st.spinner(f'Analisando curr√≠culo de {nome_candidato}...'):
                                dados = gpt_service.analisar_curriculo(texto_cv)


                                if not dados['profissional']['nome'] and info.get('nome'):
                                    dados['profissional']['nome'] = info['nome']
                                if not dados['profissional']['email'] and info.get('email'):
                                    dados['profissional']['email'] = info['email']
                                if not dados['profissional']['telefone'] and info.get('telefone'):
                                    dados['profissional']['telefone'] = info['telefone']

                                data_service.salvar_profissional(dados, texto_cv)
                                st.success(f"‚úÖ Curr√≠culo de {nome_candidato} processado com sucesso")
                        except Exception as e:
                            st.error(f"‚ùå Erro ao processar curr√≠culo de {nome_candidato}: {e}")

                except Exception as e:
                    st.error(f"‚ùå Erro ao processar arquivo {arquivo.name}: {e}")

            progress_bar.empty()
            status_text.empty()


            st.markdown("### Resumo do Processamento")
            st.markdown(f"""
            - Total de arquivos processados: {len(arquivos)}
            - Total de curr√≠culos encontrados: {total_curriculos}
            - Total de curr√≠culos processados com sucesso: {total_processado}
            """)

def render_viewer():
    st.markdown(VIEWER_STYLES, unsafe_allow_html=True)
    st.header("Visualiza√ß√£o dos Dados")

    try:
        data_service = DataService()


        tabela_selecionada = st.selectbox(
            "Selecione a tabela para visualizar:",
            [
                "Profissionais",
                "G√™neros",
                "Faculdades",
                "Idiomas",
                "√Åreas de Interesse",
                "√Åreas de Atua√ß√£o",
                "Profissionais-Idiomas",
                "Profissionais-√Åreas de Interesse",
                "Profissionais-√Åreas de Atua√ß√£o"
            ]
        )


        if tabela_selecionada == "Profissionais":
            query = """
                SELECT p.*, 
                    p.cargo_atual,
                    g.nome as genero,
                    f.nome as faculdade,
                    i.nome as idioma_principal,
                    p.habilidades
                FROM profissionais p
                LEFT JOIN generos g ON p.genero_id = g.id
                LEFT JOIN faculdades f ON p.faculdade_id = f.id
                LEFT JOIN idiomas i ON p.idioma_principal_id = i.id
            """
        elif tabela_selecionada == "G√™neros":
            query = "SELECT * FROM generos"
        elif tabela_selecionada == "Faculdades":
            query = "SELECT * FROM faculdades"
        elif tabela_selecionada == "Idiomas":
            query = "SELECT * FROM idiomas"
        elif tabela_selecionada == "√Åreas de Interesse":
            query = "SELECT * FROM areas_interesse"
        elif tabela_selecionada == "√Åreas de Atua√ß√£o":
            query = "SELECT * FROM areas_atuacao"
        elif tabela_selecionada == "Profissionais-Idiomas":
            query = """
                SELECT p.nome as profissional, 
                       i.nome as idioma,
                       pi.nivel,
                       pi.certificacao,
                       pi.data_certificacao
                FROM profissionais_idiomas pi
                JOIN profissionais p ON pi.profissional_id = p.id
                JOIN idiomas i ON pi.idioma_id = i.id
            """
        elif tabela_selecionada == "Profissionais-√Åreas de Interesse":
            query = """
                SELECT p.nome as profissional,
                       ai.nome as area_interesse,
                       pai.nivel_interesse
                FROM profissionais_areas_interesse pai
                JOIN profissionais p ON pai.profissional_id = p.id
                JOIN areas_interesse ai ON pai.area_interesse_id = ai.id
            """
        else:
            query = """
                SELECT p.nome as profissional,
                       aa.nome as area_atuacao,
                       paa.anos_experiencia,
                       paa.ultimo_cargo,
                       paa.ultima_empresa,
                       paa.data_inicio,
                       paa.data_fim,
                       paa.descricao_atividades
                FROM profissionais_areas_atuacao paa
                JOIN profissionais p ON paa.profissional_id = p.id
                JOIN areas_atuacao aa ON paa.area_atuacao_id = aa.id
            """


        dados = data_service.executar_query(query)

        if dados:
            df = pd.DataFrame(dados)


            col1, col2 = st.columns(2)
            with col1:
                st.metric("Total de Registros", len(df))
            with col2:
                if 'nome' in df.columns:
                    st.metric("Registros √önicos", df['nome'].nunique())


            st.subheader(f"Dados da tabela: {tabela_selecionada}")
            st.dataframe(df)


            csv = df.to_csv(index=False).encode('utf-8')
            st.download_button(
                "üì• Baixar dados como CSV",
                csv,
                f"{tabela_selecionada.lower().replace(' ', '_')}.csv",
                "text/csv",
                key='download-csv'
            )

            if len(df) > 1:
                st.subheader("Visualiza√ß√µes")

                if tabela_selecionada == "Profissionais":
                    col1, col2 = st.columns(2)
                    with col1:
                        if 'cargo_atual' in df.columns:
                            st.write("Distribui√ß√£o por Cargo")
                            cargo_counts = df['cargo_atual'].value_counts()
                            st.bar_chart(cargo_counts)
                    with col2:
                        if 'idade' in df.columns:
                            st.write("Distribui√ß√£o por Idade")
                            idade_bins = pd.cut(df['idade'].dropna(),
                                                bins=[0, 20, 25, 30, 35, 40, 45, 50, 100],
                                                labels=['0-20', '21-25', '26-30', '31-35',
                                                        '36-40', '41-45', '46-50', '50+'])
                            idade_counts = idade_bins.value_counts()
                            st.bar_chart(idade_counts)

                elif tabela_selecionada == "Profissionais-Idiomas":
                    if 'idioma' in df.columns:
                        st.write("Distribui√ß√£o por Idioma")
                        idioma_counts = df['idioma'].value_counts()
                        st.bar_chart(idioma_counts)

                        st.write("Distribui√ß√£o por N√≠vel")
                        nivel_counts = df['nivel'].value_counts()
                        st.bar_chart(nivel_counts)

                elif tabela_selecionada == "Profissionais-√Åreas de Atua√ß√£o":
                    if 'area_atuacao' in df.columns:
                        st.write("Distribui√ß√£o por √Årea de Atua√ß√£o")
                        area_counts = df['area_atuacao'].value_counts()
                        st.bar_chart(area_counts)

                        if 'anos_experiencia' in df.columns:
                            st.write("Distribui√ß√£o por Anos de Experi√™ncia")
                            exp_bins = pd.cut(df['anos_experiencia'].dropna(),
                                              bins=[0, 2, 5, 8, 100],
                                              labels=['0-2 anos', '2-5 anos',
                                                      '5-8 anos', '8+ anos'])
                            exp_counts = exp_bins.value_counts()
                            st.bar_chart(exp_counts)
        else:
            st.info(f"Nenhum dado encontrado na tabela {tabela_selecionada}")

    except Exception as e:
        st.error(f"Erro ao carregar dados: {e}")


def render_query():
    st.markdown(QUERY_STYLES, unsafe_allow_html=True)
    st.title("Sistema de Consulta de Curr√≠culos")

    tab1, tab2 = st.tabs(["üìù Consulta", "üìä Estrutura do Banco"])

    with tab1:
        st.header("Consultas Personalizadas")


        st.subheader("Exemplos de Consultas")
        col1, col2 = st.columns(2)

        with col1:
            with st.expander("üéØ Consultas por Perfil", expanded=True):
                exemplos_perfil = {
                    "Profissionais por √Årea": "Encontre todos os profissionais que atuam na √°rea de desenvolvimento",
                    "Profissionais por Idioma": "Liste profissionais que falam ingl√™s fluente",
                    "Experi√™ncia Espec√≠fica": "Busque profissionais com mais de 5 anos de experi√™ncia em Python"
                }
                for titulo, query in exemplos_perfil.items():
                    if st.button(titulo, key=f"btn_{titulo}"):
                        st.session_state['query_prompt'] = query

        with col2:
            with st.expander("üìä Consultas Anal√≠ticas", expanded=True):
                exemplos_analiticos = {
                    "M√©dia Salarial": "Calcule a m√©dia salarial pretendida por √°rea de atua√ß√£o",
                    "Distribui√ß√£o por Idade": "Mostre a distribui√ß√£o de idade dos profissionais por √°rea",
                    "Top Habilidades": "Liste as 10 habilidades mais comuns entre os profissionais"
                }
                for titulo, query in exemplos_analiticos.items():
                    if st.button(titulo, key=f"btn_analytic_{titulo}"):
                        st.session_state['query_prompt'] = query


        st.markdown("---")
        prompt = st.text_area(
            "Digite sua consulta:",
            value=st.session_state.get('query_prompt', ''),
            height=100,
            placeholder="Ex: Busque profissionais formados em Engenharia que falam ingl√™s fluente..."
        )


        if st.button("üîç Consultar", type="primary"):
            try:
                with st.spinner("Gerando consulta..."):
                    gpt_service = GPTService()
                    data_service = DataService()

                    query = gpt_service.gerar_query_sql(prompt, SQL_SCHEMA)

                    if query:
                        with st.expander("üîç SQL Gerado"):
                            st.code(query, language="sql")

                        try:
                            with st.spinner("Executando consulta..."):
                                resultados = data_service.executar_query(query)

                            if resultados:

                                df = pd.DataFrame(resultados)


                                col1, col2 = st.columns([2, 1])

                                with col1:
                                    st.subheader("Resultados")
                                    st.dataframe(df)

                                with col2:
                                    st.subheader("Resumo")
                                    st.metric("Total de Registros", len(df))

                                    num_cols = df.select_dtypes(include=['int64', 'float64']).columns
                                    if len(num_cols) > 0:
                                        st.markdown("**An√°lise Num√©rica**")
                                        st.dataframe(df[num_cols].describe())

                                if len(df) > 1:
                                    st.subheader("Visualiza√ß√£o")

                                    chart_type = st.selectbox(
                                        "Tipo de Gr√°fico:",
                                        ["Barras", "Linha", "Dispers√£o"]
                                    )

                                    if len(num_cols) > 0:
                                        cols_to_plot = st.multiselect(
                                            "Colunas para visualizar:",
                                            num_cols
                                        )

                                        if cols_to_plot:
                                            if chart_type == "Barras":
                                                st.bar_chart(df[cols_to_plot])
                                            elif chart_type == "Linha":
                                                st.line_chart(df[cols_to_plot])
                                            else:
                                                if len(cols_to_plot) >= 2:
                                                    st.scatter_chart(
                                                        data=df,
                                                        x=cols_to_plot[0],
                                                        y=cols_to_plot[1]
                                                    )
                                                else:
                                                    st.warning(
                                                        "Selecione duas colunas para o gr√°fico de dispers√£o"
                                                    )
                            else:
                                st.info("Nenhum resultado encontrado")

                        except Exception as e:
                            st.error(f"Erro ao executar a consulta: {str(e)}")
                    else:
                        st.error("N√£o foi poss√≠vel gerar uma consulta SQL v√°lida")

            except Exception as e:
                st.error(f"Erro na consulta: {str(e)}")

    with tab2:
        st.header("Estrutura do Banco de Dados")


        with st.expander("üéØ Tabelas Principais", expanded=True):
            tabelas_principais = {
                "profissionais": {
                    "descri√ß√£o": "Informa√ß√µes principais dos profissionais",
                    "colunas": [
                        "id", "nome", "email", "telefone", "endereco", "portfolio_url",
                        "linkedin_url", "github_url", "cargo_atual", "faculdade_id",
                        "genero_id", "idioma_principal_id", "nivel_idioma_principal",
                        "idade", "pretensao_salarial", "disponibilidade", "tipo_contrato"
                    ]
                },
                "generos": {
                    "descri√ß√£o": "Tipos de g√™nero",
                    "colunas": ["id", "nome", "descricao"]
                },
                "faculdades": {
                    "descri√ß√£o": "Institui√ß√µes de ensino",
                    "colunas": ["id", "nome", "cidade", "estado", "pais", "tipo", "ranking"]
                },
                "idiomas": {
                    "descri√ß√£o": "Cadastro de idiomas",
                    "colunas": ["id", "nome", "codigo"]
                }
            }

            for nome, info in tabelas_principais.items():
                st.markdown(f"**{nome}**")
                st.markdown(f"_{info['descri√ß√£o']}_")
                cols = [f"`{col}`" for col in info['colunas']]
                st.markdown(", ".join(cols))
                st.markdown("---")

        with st.expander("üéØ Tabelas de Interesse e Atua√ß√£o", expanded=True):
            tabelas_areas = {
                "areas_interesse": {
                    "descri√ß√£o": "√Åreas de interesse profissional",
                    "colunas": ["id", "nome", "descricao", "total_uso", "termos_similares"]
                },
                "areas_atuacao": {
                    "descri√ß√£o": "√Åreas de atua√ß√£o profissional",
                    "colunas": ["id", "nome", "descricao", "total_uso", "termos_similares"]
                }
            }

            for nome, info in tabelas_areas.items():
                st.markdown(f"**{nome}**")
                st.markdown(f"_{info['descri√ß√£o']}_")
                cols = [f"`{col}`" for col in info['colunas']]
                st.markdown(", ".join(cols))
                st.markdown("---")

        with st.expander("üîó Tabelas de Relacionamento", expanded=True):
            relacionamentos = {
                "profissionais_idiomas": {
                    "descri√ß√£o": "Relaciona profissionais e seus idiomas",
                    "colunas": [
                        "profissional_id",
                        "idioma_id",
                        "nivel",
                        "certificacao",
                        "data_certificacao"
                    ]
                },
                "profissionais_areas_interesse": {
                    "descri√ß√£o": "Relaciona profissionais e suas √°reas de interesse",
                    "colunas": [
                        "profissional_id",
                        "area_interesse_id",
                        "nivel_interesse"
                    ]
                },
                "profissionais_areas_atuacao": {
                    "descri√ß√£o": "Relaciona profissionais e suas √°reas de atua√ß√£o",
                    "colunas": [
                        "profissional_id",
                        "area_atuacao_id",
                        "anos_experiencia",
                        "ultimo_cargo",
                        "ultima_empresa",
                        "data_inicio",
                        "data_fim",
                        "descricao_atividades"
                    ]
                }
            }

            for nome, info in relacionamentos.items():
                st.markdown(f"**{nome}**")
                st.markdown(f"_{info['descri√ß√£o']}_")
                cols = [f"`{col}`" for col in info['colunas']]
                st.markdown(", ".join(cols))
                st.markdown("---")

        # Guia de Consultas
        with st.expander("üí° Guia de Consultas", expanded=True):
            st.markdown("""
            ### Como fazer consultas efetivas:
            1. **Seja espec√≠fico**: Inclua os detalhes que deseja ver no resultado
            2. **Use os nomes das tabelas**: Consulte a estrutura acima
            3. **Combine informa√ß√µes**: Relacione dados de diferentes tabelas
            4. **Filtre resultados**: Especifique condi√ß√µes para filtrar os dados

            ### Exemplos de consultas complexas:
            - "Encontre profissionais com mais de 3 anos de experi√™ncia em desenvolvimento que falam ingl√™s fluente"
            - "Liste as √°reas de atua√ß√£o com maior m√©dia salarial pretendida"
            - "Mostre as faculdades que formaram mais profissionais em tecnologia"
            - "Busque profissionais com experi√™ncia em Python e certifica√ß√£o em AWS"

            ### Dicas para filtros:
            - Use termos espec√≠ficos como "desenvolvimento", "python", "aws"
            - Especifique anos de experi√™ncia quando relevante
            - Combine m√∫ltiplos crit√©rios para resultados mais precisos
            - Considere incluir n√≠veis de profici√™ncia em idiomas
            """)


def render_dashboard():
    st.markdown(VIEWER_STYLES, unsafe_allow_html=True)
    st.header("Dashboard de An√°lise")

    try:
        data_service = DataService()
        dados = data_service.buscar_

        with st.expander("üìù Exemplos de SQL", expanded=True):
            st.markdown("""
            ### Consultas SQL de Exemplo:

            1. **Busca b√°sica de profissionais:**
            ```sql
            SELECT p.nome, p.cargo_atual, g.nome as genero
            FROM profissionais p
            LEFT JOIN generos g ON p.genero_id = g.id
            ```

            2. **Profissionais com idiomas:**
            ```sql
            SELECT p.nome, i.nome as idioma, pi.nivel
            FROM profissionais p
            LEFT JOIN profissionais_idiomas pi ON p.id = pi.profissional_id
            LEFT JOIN idiomas i ON pi.idioma_id = i.id
            WHERE LOWER(i.nome) = 'ingl√™s' AND pi.nivel IN ('avan√ßado', 'fluente')
            ```

            3. **Experi√™ncia em √°rea espec√≠fica:**
            ```sql
            SELECT p.nome, aa.nome as area, paa.anos_experiencia
            FROM profissionais p
            LEFT JOIN profissionais_areas_atuacao paa ON p.id = paa.profissional_id
            LEFT JOIN areas_atuacao aa ON paa.area_atuacao_id = aa.id
            WHERE LOWER(aa.nome) LIKE '%desenvolvimento%'
            AND paa.anos_experiencia >= 3
            ```
            """)

        with st.expander("üìä Tabelas Principais", expanded=True):
            st.write(dados)

    except Exception as e:
        st.error(f"Erro ao carregar dados: {e}")